---
  - name: Ensure SSH key exists locally
    user: 
      name: "{{ ansible_user_id }}"
      generate_ssh_key: yes
      ssh_key_file: .ssh/id_rsa

  - name: Ensure SSH key exists at digitalocean
    digital_ocean:
      state: present
      command: ssh
      name: AnsibleHost
      ssh_pub_key: "{{ lookup('file','~/.ssh/id_rsa.pub') }}"
      api_token: "{{ do_token }}"
    register: my_ssh_key

  - name: Ensure droplet exists
    digital_ocean:
      state: present
      command: droplet
      name: "{{ item }}"
      unique_name: yes
      size_id: 512mb
      region_id: ams2
      image_id: debian-8-x64
      ssh_key_ids: "{{ my_ssh_key.ssh_key.id }}"
      api_token: "{{ do_token }}"
      wait: yes
    with_items: "{{ droplets }}"
    register: droplet_details

  - name: Add new droplet to dynamic asset list
    add_host: name="{{ item.droplet.ip_address }}" groups="webservers"
    with_items: "{{ droplet_details.results }}"

  - name: Wait for server to become available
    wait_for:
      host: "{{ item.droplet.ip_address }}"
      port: 22
    with_items: " {{ droplet_details.results }}"
